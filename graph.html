<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBV Keyword Graph Explorer</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        svg { width: 100%; height: 100%; background: radial-gradient(circle, #1a1a2e 0%, #16213e 100%); }
        
        .node { cursor: pointer; transition: opacity 0.3s ease; }
        .node text { font-size: 12px; pointer-events: none; text-anchor: middle; fill: #fff; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        
        .link { stroke: rgba(255, 255, 255, 0.3); stroke-width: 2; transition: opacity 0.3s ease; }
        .link.broader { stroke: rgba(255, 140, 66, 0.6); stroke-width: 2.5; }
        .link.narrower { stroke: rgba(138, 104, 204, 0.6); stroke-width: 2.5; }
        .link.related { stroke: rgba(74, 144, 226, 0.6); stroke-width: 2; }
        .link.members { stroke: rgba(52, 152, 219, 0.6); stroke-width: 2; }
        
        .tooltip { position: absolute; background: rgba(0, 0, 0, 0.9); color: white; padding: 12px; border-radius: 8px; font-size: 14px; z-index: 1000; max-width: 300px; border: 1px solid rgba(255,255,255,0.2); cursor: default; pointer-events: auto; }
        .tooltip-content { pointer-events: none; }
        .tooltip-definition { font-size: 12px; color: #a7d1d2; border-top: 1px solid #444; margin-top: 8px; padding-top: 8px; font-style: italic; }
        .tooltip-translations { font-size: 12px; color: #ccc; border-top: 1px solid #444; margin-top: 8px; padding-top: 8px; }
        .tooltip-close { position: absolute; top: 5px; right: 8px; background: transparent; border: none; color: #aaa; font-size: 20px; cursor: pointer; padding: 0; line-height: 1; }
        .tooltip-close:hover { color: white; }

        .ui-panel { position: absolute; background: rgba(0, 0, 0, 0.8); color: white; padding: 15px; border-radius: 10px; z-index: 1000; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; }
        
        .control-panel { top: 20px; left: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .control-panel button { background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: background 0.3s ease; font-size: 12px; }
        .control-panel button:hover { background: #764ba2; }
        
        .search-panel { top: 20px; right: 20px; min-width: 300px; }
        .search-input { width: 100%; padding: 10px; border: none; border-radius: 5px; background: rgba(255, 255, 255, 0.9); color: #333; font-size: 14px; outline: none; box-sizing: border-box; }
        .search-suggestions { max-height: 200px; overflow-y: auto; background: white; border-radius: 5px; margin-top: 5px; display: none; }
        .suggestion-item { padding: 10px; cursor: pointer; color: #333; }
        .suggestion-item:hover { background: #667eea; color: white; }
        .current-topic { color: #4ecdc4; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
        
        .language-switcher { margin-top: 10px; display: flex; gap: 5px; }
        .lang-btn { padding: 5px 10px; border: 1px solid #667eea; background: transparent; color: #667eea; border-radius: 3px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .lang-btn.active, .lang-btn:hover { background: #667eea; color: white; }

        #related-keywords-panel { top: 85px; left: 20px; max-width: 280px; max-height: 70vh; display: none; overflow-y: auto; }
        #related-keywords-panel h3 { margin-top: 0; margin-bottom: 10px; font-size: 16px; color: #ff6b6b; border-bottom: 1px solid #ff6b6b; padding-bottom: 8px; }
        .relationship-section { margin-bottom: 15px; }
        #related-content { max-height: calc(70vh - 60px); overflow-y: auto; }
        .relationship-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; color: #4a90e2; }
        .relationship-title.broader { color: #ff8c42; }
        .relationship-title.narrower { color: #8a68cc; }
        .relationship-title.related { color: #4a90e2; }
        .relationship-title.members { color: #3498db; }
        .relationship-title.parent-collections { color: #e67e22; }
        .relationship-title.other-collections { color: #e74c3c; }
        .relationship-title.translations { color: #95a5a6; }
        #related-keywords-panel ul { list-style: none; padding: 0; margin: 0 0 10px 0; max-height: 120px; overflow-y: auto; }
        #related-keywords-panel li a { color: #eee; text-decoration: none; display: block; padding: 6px; border-radius: 3px; transition: background 0.2s ease; font-size: 13px; }
        #related-keywords-panel li a:hover { background: #667eea; }
        #related-keywords-panel li.hidden { display: none; }

        #legend { bottom: 20px; right: 20px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .legend-color.broader-shape { border-radius: 0; transform: rotate(45deg); clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        .legend-color.narrower-shape { border-radius: 0; transform: rotate(-135deg); clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        .legend-color.related-shape { border-radius: 0; transform: rotate(45deg); }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <!-- UI Panels -->
    <div class="ui-panel control-panel">
        <button id="main-menu-btn">üè† Main Menu</button>
        <button id="zoom-in-btn">‚ûï</button>
        <button id="zoom-out-btn">‚ûñ</button>
        <button id="reset-zoom-btn">üîç Reset</button>
    </div>

    <div class="ui-panel search-panel">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
            <div class="current-topic" id="current-topic" style="margin-bottom: 0;"></div>
            <a href="#" id="current-topic-cbv-link" target="_blank" style="color: #4ecdc4; text-decoration: none; font-size: 14px; display: none;" title="View current topic in CBV Source">üîó</a>
        </div>
        <input type="text" class="search-input" id="search-input" autocomplete="off">
        <div class="search-suggestions" id="search-suggestions"></div>
        <div class="language-switcher">
            <button class="lang-btn active" data-lang="en">EN</button>
            <button class="lang-btn" data-lang="fr">FR</button>
            <button class="lang-btn" data-lang="es">ES</button>
        </div>
    </div>

    <div class="ui-panel" id="related-keywords-panel">
        <h3 id="panel-main-title"></h3>
        <div id="related-content"></div>
    </div>

    <div class="ui-panel" id="legend"></div>

    <svg id="graph-container"></svg>
    <div class="tooltip" id="tooltip" style="display: none;">
        <button class="tooltip-close" onclick="hideTooltip(true)">√ó</button>
        <div id="tooltip-content" class="tooltip-content"></div>
    </div>

    <script>
        // --- GLOBAL STATE AND CONSTANTS ---
        const width = window.innerWidth;
        const height = window.innerHeight;
        const svg = d3.select("#graph-container");
        const g = svg.append("g");
        const tooltip = d3.select("#tooltip");
        const zoom = d3.zoom().scaleExtent([0.1, 4]).on("zoom", (event) => g.attr("transform", event.transform));
        svg.call(zoom);

        let simulation = null, allKeywords = [], keywordData = {}, currentKeyword = '', currentLanguage = 'en', pinnedTooltipNode = null;

        // --- DATA LOADING ---
        async function loadData() {
            try {
                const response = await fetch('cbv_data.json');
                keywordData = await response.json();
                allKeywords = Object.keys(keywordData).map(name => ({ name })).sort((a, b) => a.name.localeCompare(b.name));
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('current-topic').textContent = 'Error loading data.';
            }
        }

        // --- D3 GRAPH RENDERING ---
        function drawGraph(keywordName) {
            if (simulation) simulation.stop();
            g.selectAll("*").remove();
            hideTooltip(true);

            currentKeyword = keywordName;
            const keywordInfo = keywordData[keywordName];
            if (!keywordInfo) return console.error(`Keyword "${keywordName}" not found.`);

            updateCurrentTopicDisplay(keywordName);
            const { nodes, links } = buildGraphData(keywordName, keywordInfo);
            renderGraph({ nodes, links });
            updateRelatedKeywordsPanel(keywordName, keywordInfo);
        }

        function buildGraphData(keywordName, keywordInfo) {
            const nodes = [{ id: keywordName, name: keywordName, type: 'central' }];
            const links = [];
            const nodeIds = new Set([keywordName]);

            ['broader', 'narrower', 'related', 'members'].forEach(type => {
                (keywordInfo[type] || []).forEach(relatedKeyword => {
                    if (keywordData[relatedKeyword] && !nodeIds.has(relatedKeyword)) {
                        nodes.push({ id: relatedKeyword, name: relatedKeyword, type });
                        links.push({ source: keywordName, target: relatedKeyword, type });
                        nodeIds.add(relatedKeyword);
                    }
                });
            });
            return { nodes, links };
        }

        function renderGraph(graph) {
            const centerX = width / 2, centerY = height / 2;
            const radius = Math.min(width, height) * 0.3;
            const angleSlice = graph.nodes.length > 1 ? (2 * Math.PI) / (graph.nodes.length - 1) : 0;

            graph.nodes.forEach((node, i) => {
                if (node.type === 'central') {
                    node.fx = centerX;
                    node.fy = centerY;
                } else {
                    const angle = angleSlice * (i - 1);
                    node.x = centerX + radius * Math.cos(angle);
                    node.y = centerY + radius * Math.sin(angle);
                }
            });

            simulation = d3.forceSimulation(graph.nodes)
                .force("link", d3.forceLink(graph.links).id(d => d.id).strength(0.1))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(centerX, centerY))
                .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 15));

            g.append("g").selectAll("line").data(graph.links).join("line").attr("class", d => `link ${d.type}`);
            
            const node = g.append("g").selectAll("g").data(graph.nodes).join("g")
                .attr("class", "node")
                .call(drag(simulation))
                .on("click", handleNodeClick)
                .on("dblclick", handleNodeDblClick)
                .on("mouseover", handleNodeMouseover)
                .on("mouseout", handleNodeMouseout);

            node.each(function(d) {
                const el = d3.select(this), r = getNodeRadius(d), c = getNodeColor(d);
                if (d.type === 'central') el.append("circle").attr("r", r).attr("fill", c);
                else if (d.type === 'broader') el.append("polygon").attr("points", `0,${-r*1.4} ${r*1.2},${r*0.7} ${-r*1.2},${r*0.7}`).attr("fill", c);
                else if (d.type === 'narrower') el.append("polygon").attr("points", `0,${r*1.4} ${r*1.2},${-r*0.7} ${-r*1.2},${-r*0.7}`).attr("fill", c);
                else if (d.type === 'related') el.append("polygon").attr("points", `0,${-r*1.2} ${r*1.2},0 0,${r*1.2} ${-r*1.2},0`).attr("fill", c);
                else el.append("circle").attr("r", r).attr("fill", c);
            });

            node.append("text").text(d => getDisplayLabel(d.name)).attr("dy", d => -getNodeRadius(d) - 8);

            simulation.on("tick", () => {
                g.selectAll(".link").attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                g.selectAll(".node").attr("transform", d => `translate(${d.x},${d.y})`);
            });
        }

        // --- UI & EVENT HANDLING ---
        function initializeEventListeners() {
            d3.select("#main-menu-btn").on("click", () => window.location.href = 'index.html');
            d3.select("#zoom-in-btn").on("click", () => svg.transition().call(zoom.scaleBy, 1.2));
            d3.select("#zoom-out-btn").on("click", () => svg.transition().call(zoom.scaleBy, 0.8));
            d3.select("#reset-zoom-btn").on("click", resetZoom);
            d3.selectAll(".lang-btn").on("click", (event) => switchLanguage(event.target.dataset.lang));
            svg.on('click', () => hideTooltip(true));
            setupSearch();
        }

        function handleNodeClick(event, d) {
            event.stopPropagation();
            pinnedTooltipNode = (pinnedTooltipNode === d) ? null : d;
            if (pinnedTooltipNode) showTooltip(event, d);
            else hideTooltip();
        }

        function handleNodeDblClick(event, d) { if (d.type !== 'central') navigateToTopic(d.name); }
        function handleNodeMouseover(event, d) { if (!pinnedTooltipNode) showTooltip(event, d); highlightRelated(d); }
        function handleNodeMouseout() { if (!pinnedTooltipNode) hideTooltip(); resetHighlight(); }

        function setupSearch() {
            const input = document.getElementById('search-input'), suggestions = document.getElementById('search-suggestions');
            input.addEventListener('input', () => {
                const query = input.value.toLowerCase().trim();
                if (!query) { suggestions.style.display = 'none'; return; }
                const filtered = allKeywords.filter(k => k.name.toLowerCase().includes(query)).slice(0, 8);
                suggestions.innerHTML = filtered.map(k => `<div class="suggestion-item" data-keyword="${k.name}">${k.name}</div>`).join('');
                suggestions.style.display = 'block';
            });
            suggestions.addEventListener('click', e => { if (e.target.matches('.suggestion-item')) navigateToTopic(e.target.dataset.keyword); });
            document.addEventListener('click', e => { if (!e.target.closest('.search-panel')) suggestions.style.display = 'none'; });
        }

        function updateUIText() {
            document.getElementById('main-menu-btn').innerHTML = `üè† ${getText('mainMenu')}`;
            document.getElementById('reset-zoom-btn').innerHTML = `üîç ${getText('resetZoom')}`;
            document.getElementById('search-input').placeholder = getText('searchPlaceholder');
            document.getElementById('panel-main-title').textContent = getText('relatedTopics');
            
            const legend = d3.select("#legend");
            legend.html("");
            ['centralTopic', 'narrowerTerms', 'broaderTerms', 'relatedTerms', 'collectionMembers'].forEach(key => {
                const item = legend.append("div").attr("class", "legend-item");
                item.append("div").attr("class", `legend-color ${key.replace('Terms', '-shape').replace('Topic', '').replace('Members', '')}`);
                item.append("span").text(getText(key));
            });
        }

        function updateCurrentTopicDisplay(keywordName) {
            document.getElementById('current-topic').textContent = `${getText('topic')}: ${getDisplayLabel(keywordName)}`;
            const link = document.getElementById('current-topic-cbv-link'), url = getCBVSourceURL(keywordName);
            link.href = url || '#';
            link.style.display = url ? 'inline' : 'none';
        }

        function updateRelatedKeywordsPanel(keywordName, keywordInfo) {
            const content = document.getElementById('related-content');
            content.innerHTML = '';
            let hasContent = false;

            const populate = (type, data, titleKey, itemClass = '') => {
                if (data && data.length > 0) {
                    hasContent = true;
                    const section = document.createElement('div');
                    section.className = 'relationship-section';
                    const listHTML = data.map(item => {
                        const name = typeof item === 'object' ? item.name : item;
                        const lang = typeof item === 'object' ? item.lang : null;
                        const count = typeof item === 'object' ? item.count : null;
                        const countText = count ? ` <span style="color:#95a5a6;font-size:11px;">(${count} ${getText('membersCount')})</span>` : '';
                        const linkData = lang ? `data-lang="${lang}"` : '';
                        return `<li><a href="#" class="${itemClass}" data-keyword="${name}" ${linkData}>${getDisplayLabel(name)}${countText}</a></li>`;
                    }).join('');
                    section.innerHTML = `<div class="relationship-title ${type}">${getText(titleKey)} (${data.length})</div><ul>${listHTML}</ul>`;
                    content.appendChild(section);
                }
            };

            ['broader', 'narrower', 'related', 'members'].forEach(type => populate(type, keywordInfo[type], type + 'Topics'));
            populate('parent-collections', findParentCollections(keywordName), 'parentCollections');
            if (keywordInfo.type === 'collection') {
                populate('other-collections', findOtherCollections(keywordName), 'otherCollections');
            }
            populate('translations', getTranslations(keywordName, true), 'translations', 'translation-link');

            document.getElementById('related-keywords-panel').style.display = hasContent ? 'block' : 'none';
            content.querySelectorAll('a').forEach(a => a.addEventListener('click', e => {
                e.preventDefault();
                if (e.target.classList.contains('translation-link')) {
                    switchToTranslation(e.target.dataset.keyword, e.target.dataset.lang);
                } else {
                    navigateToTopic(e.target.dataset.keyword);
                }
            }));
        }

        // --- TOOLTIP ---
        function showTooltip(event, d) {
            const contentDiv = document.getElementById('tooltip-content');
            let content = `<strong>${getDisplayLabel(d.name)}</strong>`;
            if (d.type !== 'central') content += `<br><span style="font-size:12px;color:#4ecdc4;">(${getText('doubleClickToExplore')})</span>`;
            
            const definition = getDefinition(d.name);
            if (definition) content += `<div class="tooltip-definition">${definition}</div>`;
            
            const translations = getTranslations(d.name);
            if (translations.length > 0) content += `<div class="tooltip-translations">${getText('also')}: ${translations.join(', ')}</div>`;
            
            contentDiv.innerHTML = content;
            
            const { offsetWidth, offsetHeight } = tooltip.node();
            let left = event.pageX + 15, top = event.pageY - 15;
            if (left + offsetWidth > width) left = event.pageX - offsetWidth - 15;
            if (top + offsetHeight > height) top = event.pageY - offsetHeight - 15;
            if (top < 0) top = 5;
            
            tooltip.style("display", "block").style("left", `${left}px`).style("top", `${top}px`);
        }

        function hideTooltip(force = false) {
            if (force) pinnedTooltipNode = null;
            if (!pinnedTooltipNode) tooltip.style("display", "none");
        }

        // --- VISUAL EFFECTS ---
        function highlightRelated(d) {
            g.selectAll('.node, .link').style('opacity', 0.2);
            const connectedNodeIds = new Set([d.id]);
            g.selectAll('.link').filter(l => l.source.id === d.id || l.target.id === d.id)
                .style('opacity', 1)
                .each(l => { connectedNodeIds.add(l.source.id); connectedNodeIds.add(l.target.id); });
            g.selectAll('.node').filter(n => connectedNodeIds.has(n.id)).style('opacity', 1);
        }

        function resetHighlight() { g.selectAll('.node, .link').style('opacity', 1); }
        function resetZoom() { svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity); }

        // --- D3 DRAG HELPERS ---
        function drag(simulation) {
            const dragstarted = (e,d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; };
            const dragged = (e,d) => { d.fx = e.x; d.fy = e.y; };
            const dragended = (e,d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; };
            return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
        }

        // --- UTILITY & GETTER FUNCTIONS ---
        const getNodeColor = d => ({ central: '#ff6b6b', narrower: '#8a68cc', broader: '#ff8c42', related: '#4a90e2', members: '#3498db' }[d.type] || '#ccc');
        const getNodeRadius = d => d.type === 'central' ? 20 : 10;
        const getDisplayLabel = name => keywordData[name]?.labels?.[currentLanguage]?.pref?.[0] || name;
        const getDefinition = name => keywordData[name]?.definitions?.[currentLanguage]?.[0] || keywordData[name]?.definitions?.en?.[0];
        const getCBVSourceURL = name => keywordData[name]?.uri ? `https://cbv.cwr.wto.org/showvoc/#/datasets/WTO_Thesaurus/data?resId=${encodeURIComponent(keywordData[name].uri)}` : null;
        
        function getTranslations(name, forPanel = false) {
            const labels = keywordData[name]?.labels;
            if (!labels) return [];
            return ['es', 'fr'].reduce((acc, lang) => {
                if (labels[lang]?.pref?.length) {
                    const term = labels[lang].pref[0];
                    acc.push(forPanel ? { name: term, lang: lang } : `${term} (${lang.toUpperCase()})`);
                }
                return acc;
            }, []);
        }

        const findParentCollections = keywordName => Object.entries(keywordData).filter(([_,v]) => v.type === 'collection' && (v.members || []).includes(keywordName)).map(([k,_]) => ({ name: k })).sort((a,b) => a.name.localeCompare(b.name));
        const findOtherCollections = currentKeyword => Object.entries(keywordData).filter(([k,v]) => v.type === 'collection' && k !== currentKeyword).map(([k,v]) => ({ name: k, count: (v.members || []).length })).sort((a,b) => a.name.localeCompare(b.name));

        function navigateToTopic(topicName) {
            document.getElementById('search-input').value = '';
            document.getElementById('search-suggestions').style.display = 'none';
            window.history.pushState({ topic: topicName }, '', `?keyword=${encodeURIComponent(topicName)}`);
            drawGraph(topicName);
        }

        function switchLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
            updateUIText();
            if (currentKeyword) drawGraph(currentKeyword);
        }
        
        function switchToTranslation(term, lang) {
            const englishKeyword = Object.keys(keywordData).find(key => keywordData[key]?.labels?.[lang]?.pref?.includes(term));
            if (englishKeyword) {
                switchLanguage(lang);
                navigateToTopic(englishKeyword);
            }
        }

        // --- MULTILINGUAL TEXT ---
        const UI_TEXTS = {
            en: { mainMenu: 'Main Menu', resetZoom: 'Reset Zoom', searchPlaceholder: 'Search for a keyword...', topic: 'Topic', centralTopic: 'Central Topic', narrowerTerms: 'Narrower Terms', broaderTerms: 'Broader Terms', relatedTerms: 'Related Terms', collectionMembers: 'Collection Members', relatedTopics: 'Related Topics', broaderTopics: '‚ñ≤ Broader Topics', narrowerTopics: '‚ñº Narrower Topics', membersTopics: '‚òÖ Collection Members', parentCollections: 'üìÅ Parent Collections', otherCollections: 'üìö Other Collections', translations: '‚óé Translations', doubleClickToExplore: 'Double-click node to explore', also: 'Also', membersCount: 'members' },
            es: { mainMenu: 'Men√∫ Principal', resetZoom: 'Reiniciar Zoom', searchPlaceholder: 'Buscar...', topic: 'Tema', centralTopic: 'Tema Central', narrowerTerms: 'T√©rminos Espec√≠ficos', broaderTerms: 'T√©rminos Amplios', relatedTerms: 'T√©rminos Relacionados', collectionMembers: 'Miembros', relatedTopics: 'Temas Relacionados', broaderTopics: '‚ñ≤ Temas Amplios', narrowerTopics: '‚ñº Temas Espec√≠ficos', membersTopics: '‚òÖ Miembros', parentCollections: 'üìÅ Colecciones Padre', otherCollections: 'üìö Otras Colecciones', translations: '‚óé Traducciones', doubleClickToExplore: 'Doble clic para explorar', also: 'Tambi√©n', membersCount: 'miembros' },
            fr: { mainMenu: 'Menu Principal', resetZoom: 'R√©initialiser', searchPlaceholder: 'Rechercher...', topic: 'Sujet', centralTopic: 'Sujet Central', narrowerTerms: 'Termes Sp√©cifiques', broaderTerms: 'Termes Plus Larges', relatedTerms: 'Termes Connexes', collectionMembers: 'Membres', relatedTopics: 'Sujets Connexes', broaderTopics: '‚ñ≤ Termes Plus Larges', narrowerTopics: '‚ñº Termes Sp√©cifiques', membersTopics: '‚òÖ Membres', parentCollections: 'üìÅ Collections Parentes', otherCollections: 'üìö Autres Collections', translations: '‚óé Traductions', doubleClickToExplore: 'Double-cliquez pour explorer', also: 'Aussi', membersCount: 'membres' }
        };
        const getText = (key) => UI_TEXTS[currentLanguage]?.[key] || UI_TEXTS.en[key];

        // --- INITIALIZATION ---
        async function init() {
            await loadData();
            if (allKeywords.length === 0) return;
            const initialTopic = new URLSearchParams(window.location.search).get('keyword') || allKeywords[Math.floor(Math.random() * allKeywords.length)].name;
            initializeEventListeners();
            updateUIText();
            drawGraph(initialTopic);
        }

        init();
    </script>
</body>
</html>